import{t as M,i as le,j as l,r as j,m as V,b as P,A as se,a as ie,c as ne,g as Q,d as me}from"./index-BvBSYTBq.js";import{r as c}from"./react-core-C6dLrvtP.js";import{l as Z,V as f}from"./visactor-Bw5377hb.js";import{L as A,F as _,B as de,S as ce}from"./semi-ui-Bu2vRZ6A.js";import"./tools-BYm9mvJU.js";import"./react-components-xfTEsaUe.js";import"./semantic-NrADMDYN.js";const q="Inter,-apple-system,BlinkMacSystemFont,Segoe UI,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Helvetica Neue,Helvetica,Arial,sans-serif",I="theme-mode",G=(o,r,t)=>{const a=o&&getComputedStyle(t??document.body).getPropertyValue(o)||r;return a&&!isNaN(a[0])?`rgba(${a})`:a},ue=(o,r,t)=>{new MutationObserver(a=>{a.forEach(s=>{s.attributeName===r&&t(s)})}).observe(o,{attributes:!0})},ge=(o,r,t,a)=>r.map((s,d)=>{const{scheme:h}=t[d];return Object.assign(Object.assign({},s),{scheme:s.scheme.map((u,p)=>G(typeof u=="object"?u[o]:u,h==null?void 0:h[p],a))})}),he=(o,r,t,a)=>{const s={};return Object.keys(r).forEach(d=>{const h=typeof r[d]=="object"?r[d][o]:r[d];s[d]=G(h,t[d],a)}),s},z=()=>document.body.hasAttribute(I)&&document.body.getAttribute(I)==="dark"?"dark":"light",pe=o=>`semiDesign${o[0].toUpperCase()}${o.slice(1)}`,be=o=>{new MutationObserver(r=>{r.forEach(t=>{var a;if(t.addedNodes.length===1){const s=t.addedNodes[0];s.tagName==="LINK"&&((a=s.getAttribute)===null||a===void 0?void 0:a.call(s,"semi-theme-switcher"))==="true"&&o(t,s)}})}).observe(document.body,{childList:!0})},Ce={default:{dataScheme:Z.colorScheme.default.dataScheme,palette:{backgroundColor:"#16161a",borderColor:"rgba(255,255,255,0.08)",shadowColor:"rgba(0,0,0,0.25)",hoverBackgroundColor:"rgba(255,255,255,0.12)",sliderRailColor:"rgba(255,255,255,0.12)",sliderHandleColor:"#e4e7f5",sliderTrackColor:"rgba(84,169,255,1)",popupBackgroundColor:"#43444a",primaryFontColor:"rgba(249,249,249,1)",secondaryFontColor:"rgba(249,249,249,0.8)",tertiaryFontColor:"rgba(249,249,249,0.6)",axisLabelFontColor:"rgba(249,249,249,0.6)",disableFontColor:"rgba(249,249,249,0.35)",axisMarkerFontColor:"#16161a",axisGridColor:"rgba(255,255,255,0.08)",axisDomainColor:"rgba(255,255,255,0.08)",dataZoomHandleStrokeColor:"rgba(46,50,56,0.13)",dataZoomChartColor:"rgba(255,255,255,0.16)",playerControllerColor:"rgba(84,169,255,1)",axisMarkerBackgroundColor:"rgba(249,249,249,1)",markLabelBackgroundColor:"rgba(255,255,255,0.08)",markLineStrokeColor:"rgba(249,249,249,0.8)",dangerColor:"rgba(252,114,90,1)",warningColor:"rgba(255,174,67,1)",successColor:"rgba(93,194,100,1)",infoColor:"rgba(84,169,255,1)"}}},fe={name:"semiDesignDark",description:"Semi Design - dark",type:"dark",fontFamily:q,colorScheme:Ce},xe={default:{dataScheme:Z.colorScheme.default.dataScheme,palette:{backgroundColor:"rgba(255,255,255,1)",borderColor:"rgba(28,31,35,0.08)",shadowColor:"rgba(0,0,0,0.1)",hoverBackgroundColor:"rgba(46,50,56,0.05)",sliderRailColor:"rgba(46,50,56,0.05)",sliderHandleColor:"rgba(255,255,255,1)",sliderTrackColor:"rgba(0,100,250,1)",popupBackgroundColor:"rgba(255,255,255,1)",primaryFontColor:"rgba(28,31,35,1)",secondaryFontColor:"rgba(28,31,35,0.8)",tertiaryFontColor:"rgba(28,31,35,0.62)",axisLabelFontColor:"rgba(28,31,35,0.62)",disableFontColor:"rgba(28,31,35,0.35)",axisMarkerFontColor:"rgba(255,255,255,1)",axisGridColor:"rgba(28,31,35,0.08)",axisDomainColor:"rgba(28,31,35,0.15)",dataZoomHandleStrokeColor:"rgba(46,50,56,0.13)",dataZoomChartColor:"rgba(46,50,56,0.09)",playerControllerColor:"rgba(0,100,250,1)",axisMarkerBackgroundColor:"rgba(28,31,35,1)",markLabelBackgroundColor:"rgba(28,31,35,0.08)",markLineStrokeColor:"rgba(28,31,35,0.8)",dangerColor:"rgba(249,57,32,1)",warningColor:"rgba(252,136,0,1)",successColor:"rgba(59,179,70,1)",infoColor:"rgba(0,100,250,1)"}}},ye={name:"semiDesignLight",description:"Semi Design - light",type:"light",fontFamily:q,colorScheme:xe},_e={backgroundColor:"--semi-color-bg-0",borderColor:"--semi-color-border",hoverBackgroundColor:"--semi-color-fill-0",sliderRailColor:"--semi-color-fill-0",sliderHandleColor:"--semi-white",sliderTrackColor:"--semi-color-primary",popupBackgroundColor:"--semi-color-bg-3",primaryFontColor:"--semi-color-text-0",secondaryFontColor:"--semi-color-text-1",tertiaryFontColor:"--semi-color-text-2",axisLabelFontColor:"--semi-color-text-0",disableFontColor:"--semi-color-disabled-text",axisMarkerFontColor:"--semi-color-bg-0",axisGridColor:"--semi-color-border",axisDomainColor:{light:"--semi-grey-9",dark:"--semi-color-border"},dataZoomHandleStrokeColor:{light:"--semi-color-fill-2"},dataZoomChartColor:"--semi-color-fill-1",playerControllerColor:"--semi-color-primary",axisMarkerBackgroundColor:"--semi-color-text-0",markLabelBackgroundColor:"--semi-color-border",markLineStrokeColor:"--semi-color-text-1",dangerColor:"--semi-color-danger",warningColor:"--semi-color-warning",successColor:"--semi-color-success",infoColor:"--semi-color-info"},Se=[{maxDomainLength:10,scheme:["--semi-color-data-0","--semi-color-data-2","--semi-color-data-4","--semi-color-data-6","--semi-color-data-8","--semi-color-data-10","--semi-color-data-12","--semi-color-data-14","--semi-color-data-16","--semi-color-data-18"]},{scheme:["--semi-color-data-0","--semi-color-data-1","--semi-color-data-2","--semi-color-data-3","--semi-color-data-4","--semi-color-data-5","--semi-color-data-6","--semi-color-data-7","--semi-color-data-8","--semi-color-data-9","--semi-color-data-10","--semi-color-data-11","--semi-color-data-12","--semi-color-data-13","--semi-color-data-14","--semi-color-data-15","--semi-color-data-16","--semi-color-data-17","--semi-color-data-18","--semi-color-data-19"]}],ke={light:ye,dark:fe},N=(o,r)=>{const t=ke[o],{dataScheme:a,palette:s}=t.colorScheme.default,d={default:{dataScheme:ge(o,Se,a,r),palette:he(o,_e,s,r)}};return Object.assign(Object.assign({},t),{colorScheme:d})},ve=o=>{const{defaultMode:r,isWatchingMode:t=!0,isWatchingThemeSwitch:a=!1}=o??{};L(!1,r),t&&ue(document.body,I,()=>L()),a&&be(()=>{const s=z(),d=JSON.stringify(N(s).colorScheme);let h=0;const u=setInterval(()=>{const p=N(s);(h>50||d!==JSON.stringify(p.colorScheme))&&(L(!0,s,p),clearInterval(u)),h++},100)})},L=(o,r,t)=>{r||(r=z());const a=pe(r);(o||f.ThemeManager.getCurrentTheme()!==a)&&(o&&f.ThemeManager.removeTheme(a),f.ThemeManager.themeExist(a)||f.ThemeManager.registerTheme(a,t??N(r)),f.ThemeManager.setCurrentTheme(a))},Ne=o=>{const r=c.useRef();let t=new Date;const[a,s]=c.useState({username:"",token_name:"",model_name:"",start_timestamp:localStorage.getItem("data_export_default_time")==="hour"?M(t.getTime()/1e3-86400):localStorage.getItem("data_export_default_time")==="week"?M(t.getTime()/1e3-86400*30):M(t.getTime()/1e3-86400*7),end_timestamp:M(t.getTime()/1e3+3600),channel:"",data_export_default_time:""}),{username:d,model_name:h,start_timestamp:u,end_timestamp:p,channel:Fe}=a,R=le(),$=c.useRef(!1),[B,J]=c.useState(null),[E,Y]=c.useState(null),[H,W]=c.useState(!1),[Te,K]=c.useState([]),[De,X]=c.useState(0),[we,ee]=c.useState(0),[x,te]=c.useState(localStorage.getItem("data_export_default_time")||"hour"),F=(e,m)=>{if(m==="data_export_default_time"){te(e);return}s(n=>({...n,[m]:e}))},T={type:"bar",data:[{id:"barData",values:[]}],xField:"Time",yField:"Usage",seriesField:"Model",stack:!0,legends:{visible:!0},title:{visible:!0,text:"模型消耗分布",subtext:"0"},bar:{state:{hover:{stroke:"#000",lineWidth:1}}},tooltip:{mark:{content:[{key:e=>e.Model,value:e=>j(parseFloat(e.Usage),4)}]},dimension:{content:[{key:e=>e.Model,value:e=>e.Usage}],updateContent:e=>{e.sort((n,g)=>g.value-n.value);let m=0;for(let n=0;n<e.length;n++)m+=parseFloat(e[n].value),e[n].value=j(parseFloat(e[n].value),4);return e.unshift({key:"总计",value:j(m,4)}),e}}},color:{specified:V}},D={type:"pie",data:[{id:"id0",values:[{type:"null",value:"0"}]}],outerRadius:.8,innerRadius:.5,padAngle:.6,valueField:"value",categoryField:"type",pie:{style:{cornerRadius:10},state:{hover:{outerRadius:.85,stroke:"#000",lineWidth:1},selected:{outerRadius:.85,stroke:"#000",lineWidth:1}}},title:{visible:!0,text:"模型调用次数占比"},legends:{visible:!0,orient:"left"},label:{visible:!0},tooltip:{mark:{content:[{key:e=>e.type,value:e=>P(e.value)}]}},color:{specified:V}},O=async(e,m)=>{W(!0);let n="",g=Date.parse(u)/1e3,y=Date.parse(p)/1e3;R?n=`/api/data/?username=${d}&start_timestamp=${g}&end_timestamp=${y}&default_time=${x}`:n=`/api/data/self/?start_timestamp=${g}&end_timestamp=${y}&default_time=${x}`;const S=await se.get(n),{success:k,message:b,data:i}=S.data;if(k){K(i),i.length===0&&i.push({count:0,model_name:"无数据",quota:0,created_at:t.getTime()/1e3});let C=3600;x==="day"?C=86400:x==="week"&&(C=604800),i.forEach(v=>{v.created_at=Math.floor(v.created_at/C)*C}),re(e,m,i)}else ie(b);W(!1)},ae=async()=>{await O(B,E)},oe=async()=>{let e=B;B||(e=new f(T,{dom:"model_data"}),J(e),e.renderAsync());let m=E;E||(m=new f(D,{dom:"model_pie"}),Y(m),m.renderAsync()),console.log("init vchart"),await O(e,m)},re=(e,m,n)=>{let g=[],y=[],S=0,k=0;for(let b=0;b<n.length;b++){const i=n[b];S+=i.quota,k+=i.count;let C=g.find(w=>w.type===i.model_name);C?C.value+=i.count:g.push({type:i.model_name,value:i.count});let v=ne(i.created_at,x),U=y.find(w=>w.Time===v&&w.Model===i.model_name);U?U.Usage+=parseFloat(Q(i.quota)):y.push({Time:v,Model:i.model_name,Usage:parseFloat(Q(i.quota))})}X(S),ee(k),g.sort((b,i)=>i.value-b.value),D.title.subtext=`总计：${P(k)}`,D.data[0].values=g,T.title.subtext=`总计：${me(S,2)}`,T.data[0].values=y,m.updateSpec(D),e.updateSpec(T),m.reLayout(),e.reLayout()};return c.useEffect(()=>{$.current||(ve({isWatchingThemeSwitch:!0}),$.current=!0,oe())},[]),l.jsx(l.Fragment,{children:l.jsxs(A,{children:[l.jsx(A.Header,{children:l.jsx("h3",{children:"数据看板"})}),l.jsxs(A.Content,{children:[l.jsx(_,{ref:r,layout:"horizontal",style:{marginTop:10},children:l.jsxs(l.Fragment,{children:[l.jsx(_.DatePicker,{field:"start_timestamp",label:"起始时间",style:{width:272},initValue:u,value:u,type:"dateTime",name:"start_timestamp",onChange:e=>F(e,"start_timestamp")}),l.jsx(_.DatePicker,{field:"end_timestamp",fluid:!0,label:"结束时间",style:{width:272},initValue:p,value:p,type:"dateTime",name:"end_timestamp",onChange:e=>F(e,"end_timestamp")}),l.jsx(_.Select,{field:"data_export_default_time",label:"时间粒度",style:{width:176},initValue:x,placeholder:"时间粒度",name:"data_export_default_time",optionList:[{label:"小时",value:"hour"},{label:"天",value:"day"},{label:"周",value:"week"}],onChange:e=>F(e,"data_export_default_time")}),R&&l.jsx(l.Fragment,{children:l.jsx(_.Input,{field:"username",label:"用户名称",style:{width:176},value:d,placeholder:"可选值",name:"username",onChange:e=>F(e,"username")})}),l.jsx(_.Section,{children:l.jsx(de,{label:"查询",type:"primary",htmlType:"submit",className:"btn-margin-right",onClick:ae,loading:H,children:"查询"})})]})}),l.jsxs(ce,{spinning:H,children:[l.jsx("div",{style:{height:500},children:l.jsx("div",{id:"model_pie",style:{width:"100%",minWidth:100}})}),l.jsx("div",{style:{height:500},children:l.jsx("div",{id:"model_data",style:{width:"100%",minWidth:100}})})]})]})]})})};export{Ne as default};
